 pipeline {
  agent any
  stages {

    stage('git') {
      steps {
        git url: 'https://github.com/henrimfonzie/TP-CI-CD.git'
      }
    }

    stage('build') {
      steps {
        sh 'cd ./Docker && docker build -t python-tp:1.0 .'
      }
    }

    stage('run') {
      steps {
        sh 'docker run --rm -p 5542:5000 -d --name python-tp python-tp:1.0'
        sh 'docker tag python-tp:1.0 henrimfonzie/python-tp-k8s:1.0'
      }
    }

    stage('test and stop') {
      steps {
        sh 'sleep 4'
        sh 'curl http://192.168.33.20:5542'
        sh 'echo $?'
        sh 'sleep 4'
        sh 'docker stop python-tp'
      }
    }

    stage('push Image') {
            steps{

              sh 'docker push henrimfonzie/python-tp-k8s:1.0'

                }
        } 

    stage('deploy') {
            steps {
               sh 'ansible playbook'
            }
        }  
  }
 }